{% extends 'base.html' %}

{% block content %}
<div class="container-fluid mt-4">
    <h1 class="mb-4">
        <i class="fas fa-brain"></i> Analytics Dashboard
    </h1>
    
    <!-- KPIs -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5>Equipment Health</h5>
                    <h2>{{ health_score }}%</h2>
                    <small>Overall system health score</small>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h5>MTBF</h5>
                    <h2>{% if mtbf %}{{ mtbf|floatformat:0 }} days{% else %}N/A{% endif %}</h2>
                    <small>Mean Time Between Failures</small>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5>MTTR</h5>
                    <h2>{% if mttr %}{{ mttr|floatformat:1 }} hrs{% else %}N/A{% endif %}</h2>
                    <small>Mean Time To Repair</small>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <h5>Next Month</h5>
                    <h2>{{ next_month.predicted_requests }}</h2>
                    <small>Predicted maintenance requests</small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Predictions -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-line"></i> Maintenance Predictions</h5>
                </div>
                <div class="card-body">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Equipment</th>
                                <th>Days Until Maintenance</th>
                                <th>Priority</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for pred in predictions %}
                            <tr>
                                <td>{{ pred.equipment.name }}</td>
                                <td>
                                    {% if pred.days_until_maintenance %}
                                        {{ pred.days_until_maintenance }} days
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="progress">
                                        {% if pred.priority_score >= 80 %}
                                            <div class="progress-bar bg-danger" data-width="{{ pred.priority_score }}">{{ pred.priority_score }}</div>
                                        {% elif pred.priority_score >= 50 %}
                                            <div class="progress-bar bg-warning" data-width="{{ pred.priority_score }}">{{ pred.priority_score }}</div>
                                        {% else %}
                                            <div class="progress-bar bg-success" data-width="{{ pred.priority_score }}">{{ pred.priority_score }}</div>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-success">{{ pred.equipment.get_status_display }}</span>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center">No predictions yet.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-cogs"></i> Model Training</h5>
                </div>
                <div class="card-body">
                    <p>Train ML model on latest data.</p>
                    <a href="{% url 'maintenance:train_model' %}" class="btn btn-primary w-100">
                        <i class="fas fa-robot"></i> Train Model
                    </a>
                    
                    <hr>
                    
                    <h6>Quick Stats:</h6>
                    <ul>
                        <li>Equipment Due Soon: <strong>{{ next_month.equipment_due_soon }}</strong></li>
                        <li>Avg Daily Requests: <strong>{{ next_month.avg_daily_requests }}</strong></li>
                    </ul>
                    
                    <a href="{% url 'maintenance:anomalies' %}" class="btn btn-warning w-100 mt-2">
                        <i class="fas fa-exclamation-triangle"></i> Detect Anomalies
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Trends Chart -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-area"></i> Maintenance Trends</h5>
                </div>
                <div class="card-body">
                    <canvas id="trendsChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Equipment Utilization -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-tachometer-alt"></i> Equipment Utilization</h5>
                </div>
                <div class="card-body">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Equipment</th>
                                <th>Utilization Rate</th>
                                <th>Downtime Hours</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for util in utilization %}
                            <tr>
                                <td>{{ util.equipment.name }}</td>
                                <td>
                                    <div class="progress">
                                        <div class="progress-bar bg-success" data-width="{{ util.utilization_rate }}">
                                            {{ util.utilization_rate|floatformat:1 }}%
                                        </div>
                                    </div>
                                </td>
                                <td>{{ util.downtime_hours|floatformat:1 }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="text-center">No data yet.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set progress bar widths dynamically
    var progressBars = document.querySelectorAll('.progress-bar');
    progressBars.forEach(function(bar) {
        var width = bar.getAttribute('data-width');
        if (width) {
            bar.style.width = width + '%';
        }
    });
    
    // Chart
    var chartCanvas = document.getElementById('trendsChart');
    if (chartCanvas) {
        var ctx = chartCanvas.getContext('2d');
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5'],
                datasets: [{
                    label: 'Maintenance Requests',
                    data: [5, 8, 6, 10, 7],
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1,
                    fill: true,
                    backgroundColor: 'rgba(75, 192, 192, 0.2)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}